# Fusion pipeline should attempt to generate specified files
- name: test-fusion-dry-run-trio
  tags:
    - dry-run
    - fusion
  command: >
    snakemake -n
    --snakefile includes/fusion/Snakefile
    --printshellcmds
    --configfile test/data/config/chrM-fusioncatcher.json
    --config pepfile=test/pep/chrM-trio.csv
  stdout:
    contains:
      # fusion pipeline should generate the following files
      - "TestSample1/fusion/TestSample1.star-fusion"
      - "TestSample1/fusion/TestSample1.star-fusion-circos/fsnviz.png"
      - "TestSample1/fusion/star-fusion/star-fusion.fusion_predictions.tsv"
      - "TestSample1/fusion/fusioncatcher/final-list_candidate-fusion-genes.txt"
      - "TestSample1/fusion/TestSample1.fusioncatcher"
      - "TestSample1/fusion/TestSample1.fusioncatcher-circos/fsnviz.png"
      - "TestSample1/fusion/TestSample1.fuma"
      - "TestSample1/fusion/TestSample1.sf-isect"
      # fusion pipeline should handle multiple samples
      - "TestSample2/fusion/TestSample2.star-fusion"
      - "TestSample2/fusion/TestSample2.star-fusion-circos/fsnviz.png"
      - "TestSample2/fusion/star-fusion/star-fusion.fusion_predictions.tsv"
      - "TestSample2/fusion/fusioncatcher/final-list_candidate-fusion-genes.txt"
      - "TestSample2/fusion/TestSample2.fusioncatcher"
      - "TestSample2/fusion/TestSample2.fusioncatcher-circos/fsnviz.png"
      - "TestSample2/fusion/TestSample2.fuma"
      - "TestSample2/fusion/TestSample2.sf-isect"
      # fusion pipeline should create a final json file
      - "TestSample2/fusion/fusion-output.json"
    contains_regex:
      - 'STAR-Fusion .* --left_fq test/data/fastq/SRR8615409_chrM_1.fastq.gz +--right_fq test/data/fastq/SRR8615409_chrM_2.fastq.gz'

# Singularity should be available
- name: test-fusion-sanity-singularity
  tags:
    - sanity
    - fusion
  command: >
    singularity --version
  stdout:
    contains_regex:
      - "singularity(-ce)? version 3"

# Fusion pipeline should run successfully
- name: test-fusion-chrM
  tags:
    - functional
    - fusion
  command: >
    snakemake -rp
    --snakefile includes/fusion/Snakefile
    --configfile test/data/config/chrM.json
    --config pepfile=test/pep/chrM.csv
    --cores 1
    --notemp
    --verbose
    --use-singularity
    --singularity-args '--cleanenv --bind /tmp'
    --singularity-prefix '~/.singularity/cache/snakemake'
    SRR8615409/fusion/star-fusion/star-fusion.fusion_predictions.tsv
    SRR8615409/fusion/SRR8615409.star-fusion
    SRR8615409/fusion/fusion-output.json
  files:
    # Should create the star-fusion output file
    - path: SRR8615409/fusion/star-fusion/star-fusion.fusion_predictions.tsv
    # Should create the star-fusion output folder
    - path: SRR8615409/fusion/SRR8615409.star-fusion
    # Test for log files
    - path: "log/star_fusion.SRR8615409.txt"
      contains:
        - "Running CMD: /usr/local/bin/STAR"
    - path: "log/star_fusion_cp.SRR8615409.txt"
    # Test for module output file
    - path: "SRR8615409/fusion/fusion-output.json"

- name: test-fusion-output
  tags:
    - functional
    - fusion
  command: >
    bash -c "
    python3 includes/fusion/scripts/json-output.py \
      --intersected \
      --tools fusioncatcher intersection star-fusion \
      --plots \
        test/data/fusion/sample.fusioncatcher-circos/fsnviz.png \
        test/data/fusion/sample.sf-isect-circos/fsnviz.png \
        test/data/fusion/sample.star-fusion-circos/fsnviz.png \
      --tables \
        test/data/fusion/sample.fusioncatcher \
        test/data/fusion/sample.sf-isect \
        test/data/fusion/sample.star-fusion \
      > fusion-output.json
    "
  files:
    - path: fusion-output.json

- name: test-star-fusion-output
  tags:
    - functional
    - fusion
  command: >
    bash -c "
    python3 includes/fusion/scripts/json-output.py \
      --tools star-fusion \
      --plots \
        test/data/fusion/sample.star-fusion-circos/fsnviz.png \
      --tables \
        test/data/fusion/sample.star-fusion \
      > fusion-output.json
    "
  files:
    - path: fusion-output.json

- name: lint-fusion
  tags:
    - sanity
    - fusion
  command: >
    snakemake
    --lint
    --snakefile includes/fusion/Snakefile
    --configfile test/data/config/chrM.json
    --config pepfile=test/pep/chrM-bam.csv

- name: snakefmt-fusion
  tags:
    - sanity
    - fusion
  command: snakefmt --check includes/fusion
